<!DOCTYPE html>
<html lang="fr">
<head>
        <title>Persistent Archlinux USB key</title>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/pure-min.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/grids-responsive-min.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.4.0/css/font-awesome.min.css" />
        <link rel="stylesheet" href="./theme/css/main.css" />
        <link href="http://blog.devsda.fr/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="devsda - blog Full Atom Feed" />
        <link href="http://blog.devsda.fr/feeds/{slug}.atom.xml" type="application/atom+xml" rel="alternate" title="devsda - blog Categories Atom Feed" />
</head>
<body>

    <div class="navigation pure-menu pure-menu-horizontal">
        <a href="./" class="pure-menu-heading  pure-menu-link">devsda - blog</a>
        <ul class="pure-menu-list">
            <li class="pure-menu-item"></li>

            <li class="pure-menu-item"><a href="./category/less-tech.html" class="pure-menu-link">Less tech</a></li>
            <li class="pure-menu-item pure-menu-selected"><a href="./category/tech.html" class="pure-menu-link">tech</a></li>
        </ul>
    </div>


<div class="page-container">
    <div class="entry-content">
        <div class="post-meta pure-g">
            <div class="pure-u">
                <a href="./category/tech.html"><img src="../images/tech.jpg " class="post-avatar" alt="tech"></a>
            </div>
<div class="pure-u-3-4 meta-data">
    <a href="./category/tech.html" class="category">tech</a><br />

    <a class="author" href="./author/thomas.html">Thomas</a>
    &mdash; <abbr title="2018-01-25T22:20:00+01:00">jeu. 25 janvier 2018</abbr>
</div>        </div>
    </div>

    <div class="article-header-container">
        <div class="background-image-container">

            <div class="background-image" style="background-image: linear-gradient(rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.6)), url(../images/stars.png);">
                <img src="../images/stars.png" alt="Persistent Archlinux USB key">
                <div class="title">
                <h1>
                    Persistent Archlinux USB key
                </h1>
                </div>
            </div>
        </div>
    </div>

    <div class="entry-content">
        <p><em>note: This was written in a hurry.</em></p>
<h1>Intro:</h1>
<p>Setup a persistent archlinux on a USB key, with encrypted root partition, from
an existing Linux (Gentoo in my case, but you should be able to do this from various Linux distros).</p>
<p>I've essentially followed two articles from the excellent archlinux wiki:</p>
<ul>
<li><a href="https://wiki.archlinux.org/index.php/Install_from_existing_Linux">Install frome existing Linux</a></li>
<li><a href="https://wiki.archlinux.org/index.php/Install_from_existing_Linux">https://wiki.archlinux.org/index.php/Installing_Arch_Linux_on_a_USB_key</a></li>
</ul>
<p>Also,</p>
<ul>
<li>https://wiki.archlinux.org/index.php/Dm-crypt/System_configuration#Boot_loader</li>
<li>https://wiki.archlinux.org/index.php/Installation_guide</li>
</ul>
<p>could be useful.</p>
<p>I'll try my best to explain what I've added/changed to use a LUKs container for my root partition.</p>
<h1>Big picture</h1>
<ol>
<li>UEFI boots: bootx64.efi</li>
<li>
<p><code>/boot/EFI/BOOT/bootx64.efi</code> is generated by <code>grub-mkimage</code> using <code>/boot/grub/grub.cfg</code></p>
</li>
<li>
<p>initramfs starts</p>
</li>
<li>It prepares the filesystem and load early drivers. Usually, I don't use an initramfs,
    but LUKs is so easy to setup using <code>mkinitcpio</code> and an initrd (<em>initial ramdisk</em>).</li>
<li>
<p>Decrypt our root partition before giving control to the kernel</p>
</li>
<li>
<p>Kernel boots</p>
</li>
<li>
<p>Login shell</p>
</li>
</ol>
<h1>1 - Preparation</h1>
<p>I need an UEFI setup, since every laptop I use works with UEFI.</p>
<p>To achieve this, I've made <strong>two partitions</strong> (keep it simple),
The first, approx. 200mb for booting purposes, of type <em>GPT</em> and formated
using <em>FAT32</em>.
The rest, for our encrypted Archlinux system. Using a non-journalised EXT4 filesystem inside a <em>LUKs</em>
partition.</p>
<p>I'll explain this later in this blog post.</p>
<h1>2 - Setup the USB key</h1>
<ul>
<li>One GPT partition to host EFI binaries. I used <a href="https://www.gnu.org/software/parted/"><em>parted</em></a> to do that.</li>
<li>The rest is up to you. I used the whole space left on the device.</li>
</ul>
<p>You should format the GPT partition to FAT32, using
something like:</p>
<div class="highlight"><pre><span></span><span class="n">mkfs</span><span class="p">.</span><span class="n">fat</span> <span class="o">-</span><span class="n">F32</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">sdxX</span>
</pre></div>


<p>My second partition is a <a href="https://wiki.archlinux.org/index.php/Dm-crypt/Encrypting_an_entire_system#Simple_partition_layout_with_LUKS">LUKS</a>
encrypted partition.</p>
<p>From the <a href="https://wiki.archlinux.org/index.php/Dm-crypt/Encrypting_an_entire_system#Simple_partition_layout_with_LUKS">luks tutorial</a>,
merged with some advice from <a href="https://wiki.archlinux.org/index.php/Installing_Arch_Linux_on_a_USB_key">Installing Arch on a USB key</a>:</p>
<div class="highlight"><pre><span></span>$ cryptsetup -y -v luksFormat --type luks2 /dev/sdaX  <span class="c1">## your root partition on the usb key</span>
$ cryptsetup open /dev/sdaX cryptroot
$ mkfs.ext4 -O <span class="s2">&quot;^has_journal&quot;</span> /dev/mapper/cryptroot
</pre></div>


<p>Disabling journal reduce the number of IO operations.
But, be careful to <strong>always</strong> properly <code>umount</code> the partition before
unplugging your device. Otherwise, data will be lost.</p>
<h1>3 - Install archlinux</h1>
<p>Okay. Archlinux installation, even from a random Linux distribution is pretty straightforward.</p>
<p>Be sure to correctly mount your root partition using LUKs, and every other needed partition (<code>/boot</code> in my example)</p>
<div class="highlight"><pre><span></span><span class="n">root</span> <span class="err">$</span> <span class="n">cryptsetup</span> <span class="k">open</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">sdXX</span> <span class="n">cryptroot</span>
<span class="n">root</span> <span class="err">$</span> <span class="n">mount</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">mapper</span><span class="o">/</span><span class="n">cryptroot</span> <span class="o">/</span><span class="n">mnt</span>
</pre></div>


<p>Following <a href="https://wiki.archlinux.org/index.php/Install_from_existing_Linux">the Archlinux wiki (Install_from_existing_Linux)</a>, the first
step is to grab a bootstrap image (minimal archlinux system).
Decompress it directly into <code>/mnt</code>, then mount the _boot partitionÂ  with <code>mount /dev/sdXY /mnt/boot</code>.</p>
<p>Now, you can chroot into /mnt (with <code>/mnt/bin/arch-root /mnt</code>), initialize pacman keyring, prepare the base
system and configure <em>locales</em>.</p>
<h1>4 Generate initial ramdisk</h1>
<p>The inistal ramdisk is an essential thing, since we use an encrypted root partition.
We've got a few <code>HOOKS</code> to add into <code>/etc/mkinitcpio.conf</code>. According to the doc:</p>
<blockquote>
<p>Before creating the initial RAM disk <code># mkinitcpio -p linux</code>, in <code>/etc/mkinitcpio.conf</code> add the block hook to the hooks array right after udev.
This is necessary for appropriate module loading in early userspace.</p>
</blockquote>
<p>Then, generated everything with :
<code>mkinitcpio -p Linux</code>.
This is <em>why</em> you have to mount your <code>/boot</code> partition before this operation.</p>
<h1>5 - Boot related shit</h1>
<h3>Intro - how stuff will work:</h3>
<p><em>The main goal in this section is to generate a valid grub image, contained
into an efi binary. This executable could be later found by the most of EFI-bios,
either in a manual or automatic way.</em></p>
<p><em>The executable is located under <code>/boot/EFI/BOOT/bootx64.efi</code>. I had to do this
to get it working. It may be different for your contructor, do not hesitate to
googe "<my computer> efi executable location"</em></p>
<p><em>I found this technique more simple and more flexible (I can use multiple kernels, avoid <code>EFI_STUB</code>), also
less scary (I don't touch to <code>efivars</code> ;)).</em></p>
<h2>note about fstab</h2>
<p>We won't need to include <code>/</code>, the <em>root filesystem</em>, in our <em>fstab</em>, since
the kernel will decrypt and mount it (and this is why we'll manage to pass additional
paramaters to the kernel in the next section).</p>
<h2>Creating basic grub configuration</h2>
<p>Since we have just generated our initramfs (using mkinitcpio) and a kernel may have been installed into /boot,
<code>grub-mkconfig</code> should detect everything (the kernel is usually named <em>vmlinuz-linux</em>)</p>
<p>Be carefull to run <code>grub-mkconfig</code> into your chrooted environment, with all filesystems (<code>/boot</code> and <code>/</code> in our case) properly mounted.</p>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="n">chroot</span><span class="p">)</span> <span class="err">$</span> <span class="n">grub</span><span class="o">-</span><span class="n">mkconfig</span> <span class="o">-</span><span class="n">o</span> <span class="o">/</span><span class="n">boot</span><span class="o">/</span><span class="n">grub</span><span class="o">/</span><span class="n">grub</span><span class="p">.</span><span class="n">cfg</span>
</pre></div>


<h2>Editing basic grub configuration</h2>
<p>Remenber to add these kernel parameters, they are mandatory in order to decrypt your filesystem:</p>
<ul>
<li>
<p><code>cryptdevice=UUID=&lt;your device UUID&gt;:cryptroot</code>
  You can get your device's UUID with the <code>blkid</code> command.</p>
</li>
<li>
<p><code>root=/dev/mapper/cryptroot</code>
  <code>cryptroot</code> is an alias. If you decide to change it, do it also for the <code>cryptdevice</code>
  parameter above.</p>
</li>
</ul>
<div class="highlight"><pre><span></span>$ grub-mkimage   -c /boot/EFI/BOOT/grub.cfg <span class="se">\</span>
                 -d /usr/lib/grub/x86_64-efi <span class="se">\</span>
                 -o /boot/EFI/BOOT/bootx64.efi <span class="se">\</span>
                 -p /efi/boot <span class="se">\</span>
                 -O x86_64-efi <span class="se">\</span>
                 fat iso9660 part_gpt part_msdos normal boot linux configfile loopback chain <span class="se">\</span>
                 efifwsetup efi_gop efi_uga ls search search_label search_fs_uuid <span class="se">\</span>
                 search_fs_file gfxterm gfxterm_background
</pre></div>


<p>Meanwhile, here's <code>/boot/EFI/BOOT/grub.cfg</code>'s content:</p>
<div class="highlight"><pre><span></span><span class="n">configfile</span> <span class="o">/</span><span class="n">grub</span><span class="o">/</span><span class="n">grub</span><span class="p">.</span><span class="n">cfg</span>
</pre></div>


<p>were <code>/grub/grub.cfg</code> designates <code>/boot/grub/grub.cfg</code>, previously generated
by <code>grub-mkconfig</code> and edited to properly decrypt our root partition.</p>
<h1>End</h1>
<p>I had to reboot several times to see a login shell :').</p>
<p>Doing this was funny - and could eventually be useful. Be sure to use a decent USB key,
because IO performance is a little low.
It is also pretty secure (thanks <a href="https://en.wikipedia.org/wiki/Linux_Unified_Key_Setup">LUKS</a>), but you still have to trust the hardware and
low level components.</p>
<h1>PS</h1>
<p>I don't have any performant device, so starting a program is always slow.
I use this USB key as a <em>safe storage device</em>, for both backup purposes and emergency linux distro.</p>
    </div>

    <footer>
        <div class="tags">
            <a href="./tag/linux-luks-usb.html">linux luks usb</a>
        </div>
        <div class="pure-g post-footer">
            <div class="pure-u-1 pure-u-md-1-2">
                <div class="pure-g poster-info">
                    <div class="pure-u-3-4">
                        <h3 class="author-name"><a href="./author/thomas.html">Thomas</a></h3>
                        <p class="author-description">
                        </p>
                    </div>
                </div>
            </div>


            <div class="pure-u-1 pure-u-md-1-2">

                <div class="pure-g post-category-info">
                    <div class="pure-u">
                        <a href="./category/tech.html"><img src="../images/tech.jpg" alt=""></a>
                    </div>
                    <div class="pure-u-3-4">
                        <h3 class="author-name"><a href="./category/tech.html">tech</a></h3>
                        <p class="author-description">
                          Tech/code related stuff
                        </p>
                    </div>
                </div>

            </div>

        </div>


    </footer>

    <div class="entry-content">
        <div id="disqus_thread"></div>
        <script type="text/javascript">
            var disqus_shortname = 'devsda';
            (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
    </div>

</div>



    <footer class="index-footer">

        <a href="./" title="devsda - blog">devsda - blog</a>
        <a href="./category/less-tech.html">Less tech</a>
        <a href="./category/tech.html">tech</a>
        <a href="http://getpelican.com/">Pelican</a>
        <a href="http://python.org/">Python.org</a>
        <a href="https://www.laquadrature.net/fr">La Quadrature du Net</a>

    </footer>

</body>
</html>